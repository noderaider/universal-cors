<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/index.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/noderaider/universal-cors" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cors">cors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-origins">origins</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const should = require(&apos;chai&apos;).should()

const normalizePattern = pattern =&gt; pattern instanceof RegExp ? pattern : new RegExp(pattern)


const originDoesNotMatch = origin =&gt; `Origin [${origin}] did not match acceptable patterns. Request has been rejected.`
const originDoesNotExist = &apos;Origin did not exist. Request has been rejected.&apos;


const FAILURE_STATUS =  { code: 403
                        , message: &apos;403 Forbidden&apos;
                        }

const getError = req =&gt; {
  return req.headers.origin ? { message: originDoesNotMatch(req.headers.origin)
                              , code: 10
                              }
                            : { message: originDoesNotExist
                              , code: 11
                              }
}

const getOptionsHeaders = req =&gt; {
  return  { &apos;Access-Control-Allow-Origin&apos;: req.headers.origin
          , &apos;Access-Control-Max-Age&apos;: 604800 // Specifies how long the preflight response can be cached in seconds
          , &apos;Access-Control-Allow-Methods&apos;: &apos;GET, PUT, POST, DELETE&apos;
          , &apos;Access-Control-Allow-Headers&apos;: &apos;Content-Type, Authorization&apos;
          , &apos;Access-Control-Allow-Credentials&apos;: true
          }
}

const handleFailure = (req, res) =&gt; {
  res.writeHead(FAILURE_STATUS.code)
  res.end (JSON.stringify({ message: FAILURE_STATUS.message
                          , errors: [ getError(req) ]
                          }))
}

export function origins({ patterns, tracing = false, logger = console, logLevel = &apos;debug&apos; } = {}) {
  should.exist(patterns, &apos;universal-cors requires CORS origin &quot;patterns&quot; argument property to be passed. &quot;patterns&quot; can be a string, an array of string, a regex, or an array of regex.&apos;)
  const log = (...args) =&gt; tracing ? logger[logLevel](...args) : () =&gt; {}
  patterns = Array.isArray(patterns) ? patterns.map(normalizePattern) : [normalizePattern(patterns)]
  const isOk = req =&gt; {
    if(!req.headers.origin)
      return true
    return patterns.some(pattern =&gt; {
      if(pattern.test(req.headers.origin)) {
        log(&apos;origin [%s] matches pattern [%s]&apos;, req.headers.origin, pattern)
        return true
      } else {
        return false
      }
    })
  }
  return { isOk }
}


export default function cors({ patterns, usePreflight = true, tracing = false, logger = console, logLevel = &apos;debug&apos; } = {}) {
  const log = (...args) =&gt; tracing ? logger[logLevel](...args) : () =&gt; {}
  const { isOk } = origins({ patterns, tracing, logger, logLevel })

  return (req, res, next = () =&gt; { log(&apos;proxy middleware executed&apos;) }) =&gt; {
    if(usePreflight &amp;&amp; req.method === &apos;OPTIONS&apos;) {
      res.writeHead(200, getOptionsHeaders(req))
      res.end()
      log(&apos;preflight 200 response sent&apos;)
    } else {
      const resolvedOrigin = req.headers.origin || req.headers.host
      if(!resolvedOrigin)
        log(&apos;no resolved origin, bypassing cors ok check&apos;)
      if(resolvedOrigin &amp;&amp; isOk(req)) {
        /** Cors ok, write the appropriate headers. */
        if(req.headers.origin) {
          log(&apos;proxy +origin [%s], method [%s]&apos;, req.headers.host, req.method)
        } else {
          log(&apos;proxy +host [%s], method [%s]&apos;, req.headers.host, req.method)
        }
        res.setHeader(&apos;Access-Control-Allow-Origin&apos;, resolvedOrigin)
        res.setHeader(&apos;Access-Control-Allow-Credentials&apos;, true)
      } else {
        /** Cors not ok, do not write the appropriate headers. */
        if(req.headers.origin) {
          logger.error(&apos;proxy -origin [%s], method [%s]&apos;, req.headers.host, req.method)
        } else {
          log(&apos;proxy -host [%s], method [%s]&apos;, req.headers.host, req.method)
        }
      }
      next()
    }
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
